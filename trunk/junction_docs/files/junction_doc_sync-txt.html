<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">

<html><head><title>Synchronization</title><link rel="stylesheet" type="text/css" href="../styles/main.css"><script language=JavaScript src="../javascript/main.js"></script></head><body class=UnframedPage onLoad="NDOnLoad()"><script language=JavaScript><!--
if (browserType) {document.write("<div class=" + browserType + ">");if (browserVer) {document.write("<div class=" + browserVer + ">"); }}// --></script>

<!--  Generated by Natural Docs, version 1.35 -->
<!--  http://www.naturaldocs.org  -->

<!-- saved from url=(0026)http://www.naturaldocs.org -->

<table border=0 cellspacing=0 cellpadding=0 width=100%><tr><td class=MenuSection valign=top><!--START_ND_MENU--><div class=MEntry><div class=MFile><a href="junction_doc_about-txt.html">About TrimPath Junction</a></div></div><div class=MEntry><div class=MFile><a href="junction_doc_run-txt.html">Runtime Environments</a></div></div><div class=MEntry><div class=MFile><a href="junction_doc_run_browser-txt.html">Runtime In The Browser</a></div></div><div class=MEntry><div class=MFile><a href="junction_doc_run_server-txt.html">Runtime On The Server</a></div></div><div class=MEntry><div class=MFile id=MSelected>Synchronization</div></div><div class=MEntry><div class=MFile><a href="junction-js.html">TrimPath.<span class=HB> </span>junction</a></div></div><div class=MEntry><div class=MFile><a href="junctionClient-js.html">TrimPath.<span class=HB> </span>junctionClient</a></div></div><div class=MEntry><div class=MFile><a href="junctionUtil-js.html">TrimPath.<span class=HB> </span>junctionUtil</a></div></div><div class=MEntry><div class=MFile><a href="junction_doc_controller-txt.html">web-MVC Controller</a></div></div><div class=MEntry><div class=MFile><a href="junction_doc_model-txt.html">web-MVC Model</a></div></div><div class=MEntry><div class=MFile><a href="junction_doc_view-txt.html">web-MVC View</a></div></div><div class=MEntry><div class=MGroup><a href="javascript:ToggleMenu('MGroupContent1')">Index</a><div class=MGroupContent id=MGroupContent1><div class=MEntry><div class=MIndex><a href="../index/General.html">Everything</a></div></div><div class=MEntry><div class=MIndex><a href="../index/Classes.html">Classes</a></div></div><div class=MEntry><div class=MIndex><a href="../index/Functions.html">Functions</a></div></div><div class=MEntry><div class=MIndex><a href="../index/Variables.html">Variables</a></div></div><div class=MEntry><div class=MIndex><a href="../index/Properties.html">Properties</a></div></div></div></div></div><!--END_ND_MENU--></td>

<td class=ContentSection valign=top><div class=CGeneric id=MainTopic><div class=CTopic><h1 class=CTitle><a name="Synchronization"></a>Synchronization</h1><div class=CBody><p class=CParagraph>The Junction synchronization system provides several basic services to propagate and handle...</p><ul class=CBulletList><li>Codebase updates</li><li>Database schema updates or migrations</li><li>Database record-level replication</li></ul><h4 class=CHeading>simpleSync</h4><p class=CParagraph>The protocol Junction implements is called &lsquo;simpleSync&rsquo;.&nbsp;  In terms of data, its design is focused around a database-to-database level of synchronization, at the record level.&nbsp;  Other protocols, in contrast, might focus on recording and synchronizing higher-level command objects, or REST actions, or file deltas, or some other concept, with different pros and cons to each kind of synchronization.</p><h4 class=CHeading>Sync Request Initiation</h4><p class=CParagraph>A synchronization request is initiated by the client web-browser, due to the usage of the HTTP protocol.&nbsp;  As part of the sync request, the Junction client transmits...</p><ul class=CBulletList><li>its current application version,</li><li>its unique client-side database id (or &lsquo;ident&rsquo;),</li><li>its last sync request timestamp</li><li>a delta of records that have changed in the client-side database since the last sync.</li></ul><h4 class=CHeading>Database Identity (or ident)</h4><p class=CParagraph>On the database ident, each database in the Junction world is assigned a unique numeric identifier, or &lsquo;ident&rsquo;.&nbsp;  For example, eacg server-side RDBMS in a team space for a particular application has a unique ident.&nbsp;  On the client-side, each Google Gears RDBMS database will be assigned a unique ident.&nbsp;  Each time a memory-database is created by the client-side Junction system, a unique ident is assigned.</p><p class=CParagraph>Junction uses a current datetime plus random number to generate these unique database ident&rsquo;s.</p><h4 class=CHeading>Codebase Updates</h4><p class=CParagraph>In response to the sync request, the first thing the Junction server checks is that the client or requestor is running the latest or same version of application code that exists on the server.</p><p class=CParagraph>The Junction server uses the last-modified timestamp of the application code directory as the application&rsquo;s version number.&nbsp; Developers should be careful to update or &lsquo;touch&rsquo; the code directory&rsquo;s last-modified timestamp whenever the application&rsquo;s codebase changes, to force existing clients to receive new code updates.&nbsp;  Pernicious bugs might seem to appear if you forget to do a &lsquo;touch&rsquo;.</p><p class=CParagraph>If the client is running outdated code, the Junction server thus sends a response with a complete copy of the entire, latest application codebase.</p><p class=CParagraph>The client-side Junction system uses that entire, complete copy of the application codebase to &lsquo;wipe out&rsquo; its old codebase, replacing it with the new application codebase.&nbsp;  Even if you change only a single line of code in the application, this simple protocol always transmits the entire, complete application codebase to the client in response to a codebase update.</p><h4 class=CHeading>Database Schema Updates or Migrations</h4><p class=CParagraph>In the complete application codebase that the client receives, besides the web-MVC code, the client also receives database schema migration scripts.&nbsp;  These are the *.js files that live under the db/migrate directory.&nbsp;  The client-side Junction system executes these scripts to ensure its local client-side RDBMS is updated to the same schema version as the server-side RDBMS.</p><p class=CParagraph>At this point, the client-side Junction system should be running the same version of application code and database schema as the server, so the client-side Junction system tries to initiate another sync request.</p><h4 class=CHeading>Database Record-Level Replication</h4><p class=CParagraph>When the Junction server receives a sync request, it first checks that the client or requestor is running the correct version of application code and schema.&nbsp;  If the versions match what the server is running, the server proceeds in processing the delta of records that were sent by the client.</p><p class=CParagraph>The delta of records includes any table rows that were inserted, updated or deleted since the last the the client sync&rsquo;ed.</p><h4 class=CHeading>Tracking Columns</h4><p class=CParagraph>The Junction system uses special database tables and columns to help the client RDBMS track which records were changed since the last sync.&nbsp;  These special database columns are automatically created by the Junction system if you used the Junction API of createStandardTable() in your database migration scripts.&nbsp;  These special tracking columns include...</p><blockquote><pre class=CCode>- id          integer primary key autoincrement<br>- created_at  datetime<br>- updated_at  datetime<br>- active      integer<br>- version     integer<br>- id_start    integer<br>- id_start_db varchar(40)<br>- synced_at   datetime</pre></blockquote><p class=CParagraph>The created_at and updated_at columns are automatically filled and updated by the Junction system whenever you call the Model.newInstance() and save() method of a Model instance.</p><p class=CParagraph>The version number column is automatically incremented, also, whenever you call the save() method of a Model instance.</p><h4 class=CHeading>The id column</h4><p class=CParagraph>Records are assigned permanent, positive id numbers by the server-side RDBMS.&nbsp;  If the application code is executed on the Junction SSWAS (server-side web application server), getting a new id from the server-side RDBMS is easy.</p><p class=CParagraph>On the client-side Junction system, however, when a record is first created, the Junction client system does not request an id from the server.&nbsp;  Instead, the client-side Junction system just immediately assigns a &lsquo;unique&rsquo; negative id number to the record.&nbsp; The client-side Junction system tracks a monotonically decreasing negative id number on a per-database manner, so it can do fast negative-number id assignment.</p><h4 class=CHeading>The id_start and id_start_db columns</h4><p class=CParagraph>When a record is created, the Junction system also fills in the id_start column with a copy of the record&rsquo;s id number.&nbsp; If created on the client-side, then, both id and id_start will be a negative number.&nbsp;  If created on the server-side, both id and id_start will be positive.</p><p class=CParagraph>Also, the Junction system fills in the id_start_db column with the local database ident.</p><p class=CParagraph>This information helps Junction track who created the record, and helps Junction map from negative id&rsquo;s to positive id&rsquo;s (when they&rsquo;re assigned later) and vice-versa, from postitive id&rsquo;s to negative.</p><p class=CParagraph>The id_start and id_start_db columns are only assigned during record creation.</p><h4 class=CHeading>Assumptions</h4><p class=CParagraph>The Junction simpleSync protocol makes several assumptions for it to work...</p><ul class=CBulletList><li>friendly, cooperative clients and servers (no liars)</li><li>monotonically decreasing negative temporary id numbers</li><li>db identity (ident) uniqueness</li><li>synchronized clocks, or correct clock time on computers</li></ul></div></div></div>

</td>

</tr></table><div class=Footer><!--START_ND_FOOTER-->Generated by <a href="http://www.naturaldocs.org">Natural Docs</a><!--END_ND_FOOTER--></div>
<!--START_ND_TOOLTIPS-->
<!--END_ND_TOOLTIPS-->

<script language=JavaScript><!--
if (browserType) {if (browserVer) {document.write("</div>"); }document.write("</div>");}// --></script></body></html>